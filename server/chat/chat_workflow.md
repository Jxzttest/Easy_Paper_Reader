flowchart TD
    A[用户输入新问题] --> B(意图识别与状态更新)
    B --> C{判断任务类型}
    
    C -->|复杂任务/业务流程| D[Agent智能体工作流]
    C -->|精确知识问答| E[自反思RAG工作流]
    
    subgraph D [智能体工作流核心]
        D1[对话状态管理<br>维护槽位与历史] --> D2[规划与决策节点<br>分解任务步骤]
        D2 --> D3[动态工具调用<br>如查询API/数据库]
        D3 --> D4[生成整合回答]
    end
    
    subgraph E [自反思RAG核心]
        E1[检索相关文档] --> E2{评估检索质量}
        E2 -- 质量高 --> E3[生成初步答案]
        E2 -- 质量低 --> E4[优化/重写查询]
        E4 --> E1
        E3 --> E5{评估答案支持度}
        E5 -- 支持度不足 --> E1
        E5 -- 支持度足够 --> E6[生成最终答案]
    end
    
    D --> F
    E --> F
    
    F[输出最终回答] --> G{是否需要继续对话?}
    G -- 是 --> A
    G -- 否 --> H[结束会话]